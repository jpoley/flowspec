{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://jp-spec-kit/schemas/jpspec_workflow.schema.json",
  "title": "JP Spec Kit Workflow Configuration",
  "description": "Schema for validating jpspec_workflow.yml configuration files that define the spec-driven development workflow",
  "type": "object",
  "required": ["version", "states", "workflows", "transitions"],
  "additionalProperties": false,
  "properties": {
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+$",
      "description": "Configuration version (e.g., '1.0')",
      "examples": ["1.0", "2.0"]
    },
    "description": {
      "type": "string",
      "minLength": 1,
      "description": "Human-readable description of the workflow configuration"
    },
    "states": {
      "type": "array",
      "description": "Custom backlog.md states beyond default To Do/Done",
      "minItems": 1,
      "uniqueItems": true,
      "items": {
        "$ref": "#/$defs/state"
      }
    },
    "workflows": {
      "type": "object",
      "description": "Workflow phases mapped to /jpspec commands",
      "minProperties": 1,
      "additionalProperties": {
        "$ref": "#/$defs/workflow"
      },
      "propertyNames": {
        "pattern": "^[a-z][a-z0-9_]*$",
        "description": "Workflow names must be lowercase with underscores"
      }
    },
    "transitions": {
      "type": "array",
      "description": "State transitions forming a DAG (Directed Acyclic Graph)",
      "minItems": 1,
      "items": {
        "$ref": "#/$defs/transition"
      }
    },
    "agent_loops": {
      "type": "object",
      "description": "Classification of agents into inner and outer loops",
      "additionalProperties": false,
      "properties": {
        "inner_loop": {
          "type": "array",
          "description": "Agents in the inner development loop (frequent execution)",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "uniqueItems": true
        },
        "outer_loop": {
          "type": "array",
          "description": "Agents in the outer loop (less frequent, operational)",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "uniqueItems": true
        }
      }
    }
  },
  "$defs": {
    "state": {
      "type": "object",
      "description": "A workflow state definition",
      "required": ["name"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Unique state name (e.g., 'Specified', 'In Implementation')"
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of what this state means"
        }
      }
    },
    "workflow": {
      "type": "object",
      "description": "A workflow phase definition",
      "required": ["command", "agents", "input_states", "output_state"],
      "additionalProperties": false,
      "properties": {
        "command": {
          "type": "string",
          "pattern": "^/jpspec:[a-z][a-z0-9_]*$",
          "description": "The /jpspec command that triggers this workflow (e.g., '/jpspec:specify')"
        },
        "agents": {
          "type": "array",
          "description": "List of agents that participate in this workflow phase",
          "minItems": 1,
          "items": {
            "type": "string",
            "minLength": 1
          },
          "uniqueItems": true
        },
        "input_states": {
          "type": "array",
          "description": "Valid task states from which this workflow can be executed",
          "minItems": 1,
          "items": {
            "type": "string",
            "minLength": 1
          },
          "uniqueItems": true
        },
        "output_state": {
          "type": "string",
          "minLength": 1,
          "description": "The state a task transitions to after this workflow completes"
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of what this workflow phase accomplishes"
        },
        "optional": {
          "type": "boolean",
          "default": false,
          "description": "Whether this workflow phase can be skipped"
        }
      }
    },
    "transition": {
      "type": "object",
      "description": "A state transition definition",
      "required": ["from", "to", "via"],
      "additionalProperties": false,
      "properties": {
        "from": {
          "type": "string",
          "minLength": 1,
          "description": "The source state name"
        },
        "to": {
          "type": "string",
          "minLength": 1,
          "description": "The destination state name"
        },
        "via": {
          "type": "string",
          "minLength": 1,
          "description": "The workflow name that triggers this transition"
        }
      }
    }
  }
}
